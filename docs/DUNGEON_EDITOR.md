# 던전 에디터 사용 가이드

브라우저에서 직접 던전을 설계하고, AI를 훈련시켜 볼 수 있는 에디터입니다.

## 시작하기

1. 웹 서버를 실행합니다.
   ```bash
   cd web
   python -m http.server 8080
   ```
2. 브라우저에서 `http://localhost:8080/` 에 접속합니다.
3. 상단의 **Editor** 탭을 클릭하면 에디터 모드로 전환됩니다.

에디터 모드에 진입하면 7x7 기본 그리드가 생성되며, 좌측에 캔버스, 우측에 에디터 컨트롤 패널이 표시됩니다.

---

## 화면 구성

| 영역 | 설명 |
|------|------|
| **모드 탭** | Play / Editor 전환 (상단) |
| **캔버스** | 던전 미리보기 + 타일 배치 영역 |
| **Grid Size** | 그리드 가로(W) x 세로(H) 설정 |
| **Tile Palette** | 배치할 타일 종류 선택 |
| **Tools** | Brush / Eraser / Fill 도구 |
| **Actions** | Undo / Redo / Clear / Validate |
| **Save / Load** | 커스텀 던전 저장 및 불러오기 |
| **Play This Dungeon** | 제작한 던전으로 즉시 플레이 |

---

## 타일 종류

팔레트에서 배치할 수 있는 9가지 타일입니다.

| 단축키 | 타일 | 색상 | 효과 |
|--------|------|------|------|
| `0` | Empty | 남색 | 빈 칸 (이동 가능) |
| `1` | Wall | 회색 | 벽 (이동 불가) |
| `2` | Start | 파랑 | 에이전트 시작 위치 (1개만 존재) |
| `3` | Goal | 초록 | 목표 지점 (+100 보상, 1개만 존재) |
| `4` | Trap | 빨강 | 함정 (-10 HP) |
| `5` | Heal | 분홍 | 회복 (+10 HP) |
| `6` | Pit | 검정 | 구덩이 (즉사, -100 보상) |
| `7` | Gold | 노랑 | 골드 (+10 보상, 1회 수집) |
| `8` | Monster | 보라 | 몬스터 (-30 HP, 처치 시 +5G) |

> **참고**: Start와 Goal은 그리드에 각각 1개만 존재할 수 있습니다. 새로 배치하면 기존 위치가 자동으로 빈 칸으로 변경됩니다.

---

## 타일 배치

### 기본 배치 (Brush)
1. Tile Palette에서 배치할 타일을 선택합니다 (또는 숫자키 `0`-`8`).
2. 캔버스에서 **클릭** 또는 **드래그**하여 타일을 배치합니다.
3. 마우스를 움직이면 커서 위치에 배치될 타일의 **반투명 프리뷰**가 표시됩니다.

### 지우기 (Eraser)
- **방법 1**: Tools에서 **Eraser**를 선택 후 클릭/드래그
- **방법 2**: 아무 도구에서나 **우클릭**하면 해당 칸이 Empty로 변경

### 채우기 (Fill)
1. Tools에서 **Fill**을 선택합니다.
2. 캔버스에서 원하는 칸을 클릭하면, 같은 타일 종류로 연결된 영역이 선택한 타일로 일괄 변경됩니다.
3. BFS 기반으로 동작하며, 4방향(상하좌우)으로 연결된 동일 타일 영역을 채웁니다.

> **참고**: 테두리 벽(가장자리)은 보호되어 있어 수정할 수 없습니다.

---

## 그리드 크기 변경

1. **W** (가로)와 **H** (세로) 입력란에 원하는 크기를 입력합니다.
   - 최소: 3x3, 최대: 25x25
2. **Apply** 버튼을 클릭합니다.
3. 기존에 배치한 타일은 가능한 범위 내에서 보존됩니다.
4. 새 영역이 추가되면 빈 칸(Empty)으로 채워지고, 테두리에 벽이 자동 배치됩니다.
5. Start나 Goal이 잘려나간 경우, 기본 위치(좌상단/우하단)에 자동 재배치됩니다.

---

## Undo / Redo

| 방법 | 동작 |
|------|------|
| `Ctrl+Z` | 되돌리기 (Undo) |
| `Ctrl+Y` 또는 `Ctrl+Shift+Z` | 다시 실행 (Redo) |
| **Undo / Redo 버튼** | 마우스 클릭으로 동일 동작 |

- 최대 50단계까지 되돌릴 수 있습니다.
- 새 작업을 하면 Redo 스택은 초기화됩니다.

---

## 검증 (Validate)

**Validate** 버튼을 클릭하면 던전의 유효성을 검사합니다.

검사 항목:
1. **Start 타일 존재 여부** - 없으면 에러
2. **Goal 타일 존재 여부** - 없으면 에러
3. **경로 존재 여부** - Start에서 Goal까지 이동 가능한 경로가 있는지 BFS로 확인 (벽과 이동 불가 타일 제외)

결과:
- 유효: 초록색 "Valid! Ready to play." 메시지
- 오류: 빨간색 에러 메시지 (어떤 조건이 충족되지 않았는지 표시)

> **참고**: "Play This Dungeon" 버튼을 누를 때도 자동으로 검증이 실행됩니다. 검증 실패 시 플레이 모드로 전환되지 않습니다.

---

## 저장 / 불러오기

### 저장
1. **Dungeon name** 입력란에 이름을 입력합니다 (예: "My Maze").
2. **Save** 버튼을 클릭합니다.
3. 같은 이름으로 저장하면 기존 던전을 덮어씁니다.

### 불러오기
1. 드롭다운 목록에서 저장된 던전을 선택합니다.
2. **Load** 버튼을 클릭합니다.

### 삭제
1. 드롭다운에서 삭제할 던전을 선택합니다.
2. **Delete** 버튼을 클릭합니다.

> **저장 위치**: 브라우저 localStorage에 저장됩니다 (`rld_custom_dungeons` 키). 브라우저 데이터를 삭제하면 커스텀 던전도 함께 삭제됩니다.

---

## 커스텀 던전 플레이

### 에디터에서 직접 플레이
1. 던전을 완성한 후 **Play This Dungeon** 버튼을 클릭합니다.
2. 자동으로 Play 모드로 전환되며, 제작한 던전이 로드됩니다.
3. 방향키로 직접 플레이하거나, AI Training으로 학습시킬 수 있습니다.

### Play 모드 던전 드롭다운에서 선택
- 저장된 커스텀 던전은 Play 모드의 Dungeon 드롭다운에 **[Custom]** 접두사와 함께 표시됩니다.
- 예: `[Custom] My Maze`

### 커스텀 던전 규칙
- **입장 비용 0G**: 골드를 소비하지 않습니다.
- **클리어 보상 0G**: 골드를 획득하지 않습니다.
- **언락 제한 없음**: 다른 던전을 클리어하지 않아도 플레이 가능합니다.
- **진행에 영향 없음**: 기존 23개 던전의 언락/이코노미 시스템과 완전히 분리됩니다.
- **Q-Table 독립 저장**: 캐릭터별로 `rld_qtable_{캐릭터}_custom_{던전ID}`로 저장됩니다.

---

## Quick Test (에디터 내 AI 테스트)

에디터 모드를 떠나지 않고 던전에 AI를 돌려볼 수 있는 기능입니다. 설계 → 테스트 → 수정 사이클을 빠르게 반복할 수 있습니다.

### 사용법
1. 던전을 설계합니다 (유효한 상태여야 함).
2. **Quick Test** 섹션에서 **Character**와 **Episodes**를 선택합니다.
3. **Quick Test** 버튼을 클릭하면 즉시 학습이 시작됩니다.
4. 진행률 바에 현재 에피소드와 클리어율이 표시됩니다.
5. 학습 완료 후 결과 메시지가 표시됩니다.

### 학습 정책 확인
- **Show learned policy** 체크박스를 활성화하면 캔버스에 Q-Value 색상과 정책 화살표가 오버레이됩니다.
- 체크 해제 시 오버레이가 제거됩니다.
- 그리드를 수정(타일 배치, Undo, Resize 등)하면 정책 오버레이가 자동으로 해제됩니다.

### 중단
- **Stop** 버튼으로 학습을 중간에 중단할 수 있습니다.
- 에디터→Play 모드 전환 시에도 진행 중인 테스트가 자동으로 중단됩니다.

### 수렴 조건
- 최근 20 에피소드 중 95% 이상 성공 시 조기 종료됩니다.
- 설정한 에피소드 수에 도달하면 종료됩니다.

### 참고
- Quick Test는 에디터 그리드를 변경하지 않습니다 (딥카피로 훈련).
- 검증 실패 던전(START/GOAL 없음, 경로 없음)에서는 에러 메시지가 표시됩니다.

---

## 키보드 단축키 요약

| 키 | 동작 |
|----|------|
| `0` - `8` | 타일 팔레트에서 해당 번호 타일 선택 + Brush 도구 전환 |
| `Ctrl+Z` | Undo |
| `Ctrl+Y` / `Ctrl+Shift+Z` | Redo |
| 우클릭 | 해당 칸을 Empty로 지우기 |

---

## 모바일 사용

터치 디바이스에서도 에디터를 사용할 수 있습니다.
- **탭**: 타일 배치 (클릭과 동일)
- **드래그**: 여러 타일 연속 배치
- 팔레트와 도구 버튼은 터치로 선택 가능

---

## 던전 설계 팁

### 알고리즘 비교용 던전
- **SARSA vs Q-Learning**: 구덩이가 양쪽에 있는 좁은 다리 구조 (SARSA가 안전한 경로 학습에 유리)
- **Dyna-Q 쇼케이스**: 넓은 개방 공간 (모델 기반 계획이 빠른 수렴)
- **Monte Carlo vs TD**: 골드가 줄줄이 이어지다 끝에 구덩이 (MC가 한 번 경험으로 즉시 학습)

### 난이도 조절
- **쉬움**: 작은 맵(5x5~7x7), 함정 없음, 직선 경로
- **보통**: 중간 맵(9x9~13x13), 함정/회복 배치, 우회 경로
- **어려움**: 큰 맵(15x15+), 몬스터+구덩이, 복잡한 미로
- **HP 관리**: 몬스터와 회복 타일을 적절히 배치하여 HP 관리가 필요한 던전

### 주의사항
- Start에서 Goal까지 최소 1개의 이동 가능한 경로가 반드시 있어야 합니다.
- 테두리 벽은 자동으로 유지되므로 가장자리를 빈 칸으로 만들 수 없습니다.
- 너무 큰 맵(20x20+)은 학습에 많은 에피소드가 필요할 수 있습니다.
